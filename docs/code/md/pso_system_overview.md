# PSO最適化システムの解説 (`pso_config.py` & `pso_algorithm.py`)

## 1. はじめに：役割分担と連携

この最適化システムは、**設定**と**実行**の2つのPythonファイルによって構成されています。この2つが連携することで、効率的でカスタマイズ性の高い設計探査を実現しています。

- `pso_config.py`: **最適化のルールブック（設定ファイル）**
  - 最適化の「目的」や「ルール」を定義します。
  - 「良い建築とは何か？」という評価基準や、AIが変更できる設計パラメータの範囲などを設定します。

- `pso_algorithm.py`: **最適化の実行エンジン（メインスクリプト）**
  - `pso_config.py`からルールを読み込み、そのルールに従って最適化計算を最後まで実行する役割を担います。

ユーザーが**「設計の目標を変えたい」**（例：コスト重視から環境重視へ）と考える場合、主に**`pso_config.py`を編集**することになります。

---

## 2. `pso_config.py`: 最適化のルールブック

このファイルは、PSO（粒子群最適化）アルゴリズムの挙動や評価方法を細かく設定するための「設定ファイル」です。主な設定項目は以下の通りです。

### a. PSOの基本パラメータ

アルゴリズムの探査能力や計算時間を決定する基本的な設定です。

- `N_PARTICLES`: **粒子の数**。同時に探査する設計案の数です。多いほど多様な案を探せますが、計算時間が増加します。
- `MAX_ITER`: **最大反復回数**。設計案の更新を繰り返す回数です。この回数に達すると計算が終了します。
- `W`, `C1`, `C2`: **PSOの挙動を決める係数**。各粒子がどのように移動し、最適解を探すかの「性格」を決定します。

### b. 設計変数の範囲 (`variable_ranges`)

PSOが変更できる各設計パラメータの**最小値と最大値**を定義した辞書です。

```python
variable_ranges = {
    'Lx': (8, 15),          # 建物のX方向長さ(m)は8mから15mの範囲
    'Ly': (8, 15),          # 建物のY方向長さ(m)は8mから15mの範囲
    'material_columns': (0, 1) # 柱の材料は0(コンクリート)か1(木材)
    # ... 他の21個のパラメータ
}
```
- PSOは、ここで定義された範囲を逸脱することなく、最適な組み合わせを探します。

### c. 評価関数 (`calculate_fitness`)

**このシステムで最も重要な関数です。** 建物の性能評価（コスト、安全性、CO2など）から、**「フィットネス」** という単一の総合評価スコアを算出します。PSOはこの**フィットネス値が最小になる解**を探します。

```python
def calculate_fitness(cost, safety, co2, comfort, constructability):
    # 目的はコスト(cost)の最小化
    fitness = cost
    
    # ただし、安全率(safety)が2.0未満の場合は大きなペナルティを与える
    if safety < 2.0:
        fitness += (2.0 - safety) * 100000
    
    return fitness
```
- この関数をカスタマイズすることで、「CO2排出量を最重視する」「快適性を高める」といった多様な設計思想をPSOに反映させることができます（課題2の内容）。

---

## 3. `pso_algorithm.py`: 最適化の実行エンジン

このスクリプトは、`pso_config.py`の設定を読み込み、最適化プロセス全体を管理・実行します。

### 処理フロー

1.  **初期設定**: `pso_config.py`から全設定をインポートし、結果を保存するフォルダ（`pso_output/`）を準備します。
2.  **粒子群の初期化**: `variable_ranges`の範囲内で、`N_PARTICLES`個の粒子（設計案）をランダムなパラメータで生成します。
3.  **最適化ループ**: `MAX_ITER`回、以下の処理を繰り返します。
    1.  **評価**: 全ての粒子（設計案）について、`generate_building_fem_analyze.py`を呼び出し、構造解析を実行して性能（コスト、安全性など）を計算します。**ここが最も時間のかかる処理です。**
    2.  **フィットネス計算**: 計算された性能を`pso_config.calculate_fitness`に渡し、各設計案の総合評価（フィットネス）を算出します。
    3.  **最良解の更新**: 各粒子が自身の過去最良解（p-best）を更新し、さらに群れ全体での最良解（g-best）を更新します。
    4.  **粒子の移動**: PSOの数式に基づき、各粒子を次の位置（新しい設計パラメータ）へ移動させます。
    5.  **進捗の保存**: 現在の状況をターミナルに表示し、リアルタイム監視用のJSONファイル (`pso_realtime_data.json`) を更新します。
4.  **最終結果の出力**: ループ終了後、最終的に見つかった全体最良解（`g_best`）のパラメータと評価値を表示し、詳細なログをCSVファイルに保存して終了します。

---

## 4. 出力されるファイル群

`pso_algorithm.py`を実行すると、プロジェクトのルートディレクトリに`pso_output`というフォルダが作成され、その中に以下のようなファイルが生成されます。これらのファイルは、最適化の過程と結果を詳細に記録したものです。

```
pso_output/
├── csv/
│   ├── pso_gbest_history.csv       # 全体最良解(g-best)の進化履歴
│   ├── pso_particle_positions.csv  # 全粒子の全世代におけるパラメータ履歴
│   └── pso_settings.csv            # 今回の実行設定（N_PARTICLESなど）
└── pso_realtime_data.json          # リアルタイム監視ツール用のデータ
```

- **`pso_gbest_history.csv`**: 各反復回数（世代）における、その時点での最も優れた設計案のパラメータと評価値が記録されています。**収束曲線を描くための元データ**です。
- **`pso_particle_positions.csv`**: 全ての粒子が、各世代でどのようなパラメータを持っていたかの全履歴です。非常に大きなファイルになりますが、粒子群全体の動きを詳細に分析する際に使用します。
- **`pso_settings.csv`**: `N_PARTICLES`や`MAX_ITER`など、その実行で使われた設定値が保存されます。後から結果を再現・比較する際に重要です。
- **`pso_realtime_data.json`**: `monitor_pso_mac.py`が読み込むためのファイルです。最適化の進捗がリアルタイムでこのファイルに書き込まれ、Webブラウザでの可視化に使われます。

---

## 5. `gbest_generate_building.py`: 最良解の3Dモデル生成ツール

`pso_algorithm.py`は最適化計算とログの保存に専念し、3Dモデルは直接出力しません。
最適化が完了した後、**最終的に得られた最良の設計案（g-best）**を3Dモデルとして可視化するために、この`gbest_generate_building.py`スクリプトを使用します。

### 処理フロー

1.  **最良解の読み込み**: `pso_output/csv/pso_gbest_history.csv`を開き、**最終行**に記録されているパラメータ（=最終的なg-best）を読み込みます。
2.  **3Dモデル生成と評価**: 読み込んだパラメータを使って`evaluate_building_from_params`関数を実行します。これにより、以下の2つが生成されます。
    - **`gbest_building_[タイムスタンプ].FCStd`**: 最適化された建物の3Dモデルファイル。
    - **性能評価結果**: その建物の詳細な性能（コスト、安全性、CO2など）。
3.  **結果の保存**: 生成されたモデルの性能評価を、`test_results.csv`というファイルに追記します。これにより、試行した様々な設計案の性能を一覧で比較できます。

このスクリプトがあることで、**「最適化計算」と「結果の可視化」を分離**し、繰り返し最終モデルを確認する作業を効率化しています。