# test_generate_building.py 使用ガイド

## 📝 概要

`test_generate_building.py`は、建築設計の自動評価システムの入門ツールです。21個のパラメータを調整して建物を生成し、5つの評価指標で性能を分析できます。

## 🎯 このツールでできること

1. **パラメトリック建物生成**: 寸法・材料・形状を自由に設定
2. **FEM構造解析**: CalculiXによる安全性評価
3. **多角的評価**: 経済性、環境性、快適性、施工性を総合評価
4. **3Dモデル出力**: FreeCAD形式（.FCStd）で保存
5. **データ記録**: CSV形式で結果を蓄積

## 🚀 基本的な使い方

### Step 1: デフォルト実行

```bash
# Mac
/Applications/FreeCAD.app/Contents/Resources/bin/freecadcmd code/test_generate_building.py

# Windows
"C:\Program Files\FreeCAD 1.0\bin\freecadcmd.exe" code\test_generate_building.py
```

**出力例:**
```
=== 建物評価テスト実行開始 ===

入力パラメータ:
  Lx: 8.0
  Ly: 6.0
  H1: 3.0
  ...

解析実行中...

=== 解析結果 ===

【安全性】
  安全率: 2.345
  最大変位: 12.567 mm
  最大応力: 4.234 MPa

【経済性】
  建設コスト: 285,000 円/㎡
  総工費: 13,680,000 円

【環境性】
  CO2排出量: 456.7 kg-CO2/㎡
  最適化ポテンシャル: 15.3%

【快適性】
  快適性スコア: 7.25/10

【施工性】
  施工性スコア: 6.80/10

✅ 結果をCSVファイルに保存しました: test_results.csv
```

### Step 2: パラメータのカスタマイズ

ファイルを編集して、33-63行目のパラメータを変更：

```python
# 例：コンパクトな建物に変更
default_params = {
    'Lx': 6.0,           # 建物幅を8m→6mに縮小
    'Ly': 5.0,           # 建物奥行を6m→5mに縮小
    'H1': 2.8,           # 1階高さを低く
    'H2': 2.5,           # 2階高さを低く
    'tf': 150,           # 床を薄く（コスト削減）
    'bc': 250,           # 柱を細く（材料削減）
    # ...
}
```

## 📊 21個の設計パラメータ詳細

### 形状パラメータ（15個）

| パラメータ | 単位 | 範囲 | デフォルト | 影響する評価指標 |
|---|---|---|---|---|
| **Lx** | m | 5-15 | 8.0 | コスト↑、快適性↑ |
| **Ly** | m | 4-12 | 6.0 | コスト↑、快適性↑ |
| **H1** | m | 2.5-4.0 | 3.0 | 快適性↑、コスト↑ |
| **H2** | m | 2.5-4.0 | 3.0 | 快適性↑、コスト↑ |
| **tf** | mm | 100-300 | 200 | 安全性↑、コスト↑ |
| **tr** | mm | 100-250 | 150 | 安全性↑、コスト↑ |
| **bc** | mm | 200-500 | 300 | 安全性↑、コスト↑ |
| **hc** | mm | 200-500 | 300 | 安全性↑、コスト↑ |
| **tw_ext** | mm | 100-250 | 150 | 安全性↑、コスト↑ |
| **wall_tilt_angle** | 度 | -30-0 | -25 | 施工性↓、デザイン性↑ |
| **window_ratio_2f** | - | 0.2-0.8 | 0.7 | 快適性↑、安全性↓ |
| **roof_morph** | - | 0.0-1.0 | 0.9 | デザイン性↑、施工性↓ |
| **roof_shift** | - | -1.0-1.0 | 0.7 | デザイン性↑、施工性↓ |
| **balcony_depth** | m | 0-3.0 | 1.8 | 快適性↑、コスト↑ |

### 材料パラメータ（6個）

| パラメータ | 値 | 意味 | 特徴 |
|---|---|---|---|
| **material_columns** | 0/1 | 柱材料 | 0:コンクリート（強い）、1:木材（環境◎） |
| **material_floor1** | 0/1 | 1階床材料 | 0:コンクリート（遮音◎）、1:木材（軽い） |
| **material_floor2** | 0/1 | 2階床材料 | 0:コンクリート（遮音◎）、1:木材（軽い） |
| **material_roof** | 0/1 | 屋根材料 | 0:コンクリート（耐久◎）、1:木材（軽い） |
| **material_walls** | 0/1 | 外壁材料 | 0:コンクリート（遮音◎）、1:木材（環境◎） |
| **material_balcony** | 0/1 | バルコニー材料 | 0:コンクリート（耐久◎）、1:木材（軽い） |

## 📈 5つの評価指標の詳細

### 評価指標とFEM解析の関係

| 評価指標 | FEM結果の使用 | 主な計算要素 | 目標 |
|---|---|---|---|
| **🔒 安全性** | ✅ **必須** | 最大応力、最大変位、材料許容値 | 安全率 ≥ 2.0 |
| **💰 経済性** | ❌ 不使用 | 材料費、労務費、形状複雑度 | 最小化 |
| **🌱 環境性** | △ オプション | 材料CO2、運搬、施工 | 最小化 |
| **🏠 快適性** | △ 一部使用 | 空間広さ、採光、天井高、変位 | 最大化（0-10） |
| **🔨 施工性** | △ オプション | 形状複雑度、特殊要素、応力集中 | 最大化（0-10） |

**重要:** 安全性のみがFEM解析結果に完全依存します。他の指標は主に建物の幾何学情報から計算されます。

## 🔬 実験例：3パターンの比較

### パターンA: エコノミー型（30㎡）
```python
# 最小限のコンパクト設計
'Lx': 6.0, 'Ly': 5.0,
'H1': 2.8, 'H2': 2.5,
'tf': 150, 'bc': 250,
'wall_tilt_angle': 0,  # シンプルな垂直壁
'balcony_depth': 0.0   # バルコニーなし
```
期待結果: コスト最小、快適性低

### パターンB: スタンダード型（56㎡）
```python
# バランスの取れた標準設計
'Lx': 8.0, 'Ly': 7.0,
'H1': 3.0, 'H2': 2.8,
'tf': 200, 'bc': 300,
'wall_tilt_angle': -5,
'balcony_depth': 1.2
```
期待結果: 全指標バランス良好

### パターンC: プレミアム型（120㎡）
```python
# 快適性重視の高級設計
'Lx': 12.0, 'Ly': 10.0,
'H1': 3.5, 'H2': 3.2,
'tf': 250, 'bc': 400,
'wall_tilt_angle': -10,
'balcony_depth': 2.0
```
期待結果: 快適性最大、コスト高

## 📁 出力ファイル

### 1. CSVファイル（test_results.csv）
- 各実行の全パラメータと評価結果を記録
- Excelで開いて分析可能
- 複数実行の結果を自動的に追記

### 2. 3Dモデル（test_building_[timestamp].FCStd）
- FreeCADで開いて詳細確認
- 各部品（柱、床、壁、屋根）を個別に確認可能
- 材料別に色分け表示

### 3. ターミナル出力
- リアルタイムの進捗表示
- 詳細な評価結果
- エラーメッセージとデバッグ情報

## 🛠️ トラブルシューティング

### よくあるエラーと対処法

| エラー | 原因 | 対処法 |
|---|---|---|
| ImportError | モジュールが見つからない | PYTHONPATHを確認、同じディレクトリで実行 |
| Segmentation Fault | メモリ不足またはFreeCADの問題 | パラメータを標準値に戻す、FreeCAD再起動 |
| FEM解析タイムアウト | 複雑すぎる形状 | 壁傾斜角を0に、屋根形状をシンプルに |
| 安全率が低すぎる | 構造部材が細すぎる | bc, hc, tfを増やす |

### デバッグモード

詳細ログを有効化：
```python
# ファイルの22行目
os.environ['VERBOSE_OUTPUT'] = 'True'  # デフォルトで有効
```

## 💡 活用のヒント

### 1. パラメータ感度分析
1つのパラメータだけを変えて、影響を観察：
```python
# 柱サイズの影響を調査
for bc in [250, 300, 350, 400]:
    default_params['bc'] = bc
    default_params['hc'] = bc
    # 実行して結果を比較
```

### 2. 材料組み合わせの探索
```python
# 全コンクリート vs 全木材
all_concrete = {k: 0 for k in material_params}
all_wood = {k: 1 for k in material_params}
```

### 3. 最適化の前準備
- まず手動で様々なパターンを試す
- 評価指標の相関関係を理解
- その後、PSOによる自動最適化へ

## 📚 関連ドキュメント

- [FEM解析システム詳細](../docs/generate_building_fem_analyze_report.html)
- [PSO最適化ガイド](../docs/PSO_usage.html)
- [課題集](kadai_updated.md)

## 🔄 更新履歴

- **2025.08**: 材料パラメータ6個を追加
- **2025.08**: CSV出力機能を強化
- **2025.08**: タイムスタンプ付きファイル名対応

---

*最終更新: 2025年8月*