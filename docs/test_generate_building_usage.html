<\!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test_generate_building.py 使用ガイド</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h1 {
            border-bottom: 3px solid #2c3e50;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: "Courier New", Courier, monospace;
        }
        pre {
            background-color: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        pre code {
            background-color: transparent;
            color: #abb2bf;
            padding: 0;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            background-color: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        blockquote {
            border-left: 4px solid #3498db;
            margin: 20px 0;
            padding-left: 20px;
            color: #555;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        strong {
            color: #2c3e50;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .mermaid {
            text-align: center;
            margin: 20px 0;
        }
        ul, ol {
            margin-left: 20px;
        }
        li {
            margin: 5px 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
</head>
<body>
<h1 id="test_generate_buildingpy"><code>test_generate_building.py</code> 使用ガイド</h1>
<h2 id="_1">概要</h2>
<p><code>test_generate_building.py</code>は，<code>generate_building_fem_analyze.py</code>の動作確認を目的としたテストスクリプトです．指定したパラメータで建物を生成し，FEM解析を実行して結果を表示・保存します．</p>
<h2 id="_2">システム全体の流れ</h2>
<h3 id="_3">パラメータと評価指標の流れ</h3>
<div class="codehilite"><pre><span></span><code><span class="nf">graph</span><span class="w"> </span><span class="n">LR</span>
<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;入力パラメータ（20個）&quot;</span>
<span class="w">        </span><span class="n">P1</span><span class="p">[</span><span class="s">&quot;形状パラメータ&lt;br/&gt;14個&lt;br/&gt;(連続値)&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="n">P2</span><span class="p">[</span><span class="s">&quot;材料パラメータ&lt;br/&gt;6個&lt;br/&gt;(離散値)&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="kd">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;処理  generate_building_fem_analyze.py&quot;</span>
<span class="w">        </span><span class="n">M1</span><span class="p">[</span><span class="s">&quot;3Dモデル生成&lt;br/&gt;create_building()&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="n">M2</span><span class="p">[</span><span class="s">&quot;FEM解析&lt;br/&gt;run_fem_analysis()&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="n">M3</span><span class="p">[</span><span class="s">&quot;指標計算&lt;br/&gt;calculate_all_evaluations()&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="kd">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="s">&quot;出力評価指標&quot;</span>
<span class="w">        </span><span class="n">R1</span><span class="p">[</span><span class="s">&quot;安全性&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="n">R2</span><span class="p">[</span><span class="s">&quot;経済性&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="n">R3</span><span class="p">[</span><span class="s">&quot;環境性&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="n">R4</span><span class="p">[</span><span class="s">&quot;快適性&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="n">R5</span><span class="p">[</span><span class="s">&quot;施工性&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="kd">end</span>

<span class="w">    </span><span class="n">P1</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">M1</span>
<span class="w">    </span><span class="n">P2</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">M1</span>
<span class="w">    </span><span class="n">M1</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">M2</span>
<span class="w">    </span><span class="n">M2</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">M3</span>
<span class="w">    </span><span class="n">M3</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">R1</span>
<span class="w">    </span><span class="n">M3</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">R2</span>
<span class="w">    </span><span class="n">M3</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">R3</span>
<span class="w">    </span><span class="n">M3</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">R4</span>
<span class="w">    </span><span class="n">M3</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">R5</span>

<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">P1</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">e8f5e9</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">P2</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">e8f5e9</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">R1</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">ffebee</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">R2</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">fff3e0</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">R3</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">e8f5e9</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">R4</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">e3f2fd</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">R5</span><span class="w"> </span><span class="n">fill</span><span class="o">:</span><span class="err">#</span><span class="n">f3e5f5</span>
</code></pre></div>

<h2 id="20">入力パラメータ（20個）の詳細</h2>
<h3 id="14-">形状パラメータ（14個）- すべて連続値</h3>
<p>形状パラメータ14個はすべて<strong>連続値</strong>（実数値）です：</p>
<ul>
<li><strong>建物寸法（4個）</strong>: Lx, Ly, H1, H2 - 実数値 [m]</li>
<li><strong>構造部材（5個）</strong>: tf, tr, bc, hc, tw_ext - 実数値 [mm]</li>
<li><strong>設計特性（5個）</strong>: </li>
<li>wall_tilt_angle - 実数値 [度]</li>
<li>window_ratio_2f - 0.0～1.0の連続値</li>
<li>roof_morph - 0.0～1.0の連続値</li>
<li>roof_shift - -1.0～1.0の連続値</li>
<li>balcony_depth - 実数値 [m]</li>
</ul>
<h3 id="6-">材料パラメータ（6個）- 離散値</h3>
<ul>
<li>material_columns, material_floor1, material_floor2</li>
<li>material_roof, material_walls, material_balcony</li>
<li>値：0=コンクリート，1=木材（離散値）</li>
<li>※PSOでは0.0～1.0の連続値として扱い、0.5を閾値として離散化</li>
</ul>
<h2 id="5">出力評価指標（5項目）の詳細</h2>
<table>
<thead>
<tr>
<th>評価項目</th>
<th>説明</th>
<th>単位</th>
<th>良好な値</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>安全率</strong></td>
<td>FEM解析による構造安全性</td>
<td>-</td>
<td>&gt; 2.0</td>
</tr>
<tr>
<td><strong>コスト</strong></td>
<td>建設費用</td>
<td>円/m²</td>
<td>&lt; 500,000</td>
</tr>
<tr>
<td><strong>CO2排出量</strong></td>
<td>環境負荷</td>
<td>kg-CO2/m²</td>
<td>低いほど良い</td>
</tr>
<tr>
<td><strong>快適性スコア</strong></td>
<td>空間品質評価</td>
<td>0-10</td>
<td>&gt; 6.0</td>
</tr>
<tr>
<td><strong>施工性スコア</strong></td>
<td>施工難易度評価</td>
<td>0-10</td>
<td>&gt; 6.0</td>
</tr>
</tbody>
</table>
<p><strong>⚠️ 重要な注意事項</strong>：
- FEM解析（有限要素法）の内部処理では、メッシュ生成時に乱数を使用しています
- そのため、<strong>同じパラメータでも実行するたびに安全率などの値がある程度変動します</strong>
- 変動幅は通常±10〜20%程度ですが、複雑な形状では変動が大きくなることがあります
- この変動は正常な動作であり、実際の構造解析でも見られる現象です</p>
<h2 id="2">2つのスクリプトの関係性</h2>
<h3 id="_4">役割分担</h3>
<h4 id="test_generate_buildingpy_1">🧪 <code>test_generate_building.py</code>（テストスクリプト）</h4>
<ul>
<li><strong>役割</strong>: コア解析エンジンのテストとデバッグ</li>
<li><strong>責務</strong>:</li>
<li>テスト用パラメータの準備</li>
<li>解析エンジンの呼び出し（evaluate_building_from_params関数）</li>
<li>結果の整形と表示</li>
<li>CSVファイルへの記録</li>
<li>FCBakファイルの自動削除</li>
<li><strong>特徴</strong>: シンプルで単一パラメータセットの評価に特化</li>
</ul>
<h4 id="generate_building_fem_analyzepy">⚙️ <code>generate_building_fem_analyze.py</code>（コア解析エンジン）</h4>
<ul>
<li><strong>役割</strong>: 建物生成とFEM解析の実行</li>
<li><strong>責務</strong>:</li>
<li>3D建物モデルの生成</li>
<li>FEM解析の実行</li>
<li>評価指標の計算</li>
<li>FCStdファイルの保存</li>
<li><strong>特徴</strong>: 再利用可能な関数（evaluate_building_from_params）として提供</li>
</ul>
<h3 id="_5">データの流れ</h3>
<div class="codehilite"><pre><span></span><code><span class="n">graph</span><span class="w"> </span><span class="n">TB</span>
<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="k">INPUT</span><span class="o">[</span><span class="n">&quot;入力&quot;</span><span class="o">]</span>
<span class="w">        </span><span class="n">P</span><span class="o">[</span><span class="n">20個のパラメータ&lt;br/&gt;辞書形式</span><span class="o">]</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="n">TEST</span><span class="o">[</span><span class="n">&quot;test_generate_building.py　　　　&quot;</span><span class="o">]</span>
<span class="w">        </span><span class="n">T1</span><span class="o">[</span><span class="n">パラメータ準備</span><span class="o">]</span>
<span class="w">        </span><span class="n">T2</span><span class="o">[</span><span class="n">evaluate_building_from_params呼び出し</span><span class="o">]</span>
<span class="w">        </span><span class="n">T3</span><span class="o">[</span><span class="n">結果処理とCSV保存</span><span class="o">]</span>
<span class="w">        </span><span class="n">T4</span><span class="o">[</span><span class="n">FCBakファイル削除</span><span class="o">]</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="n">CORE</span><span class="o">[</span><span class="n">&quot;generate_building_fem_analyze.py　　　　&quot;</span><span class="o">]</span>
<span class="w">        </span><span class="n">G1</span><span class="o">[</span><span class="n">evaluate_building_from_params関数</span><span class="o">]</span>
<span class="w">        </span><span class="n">G2</span><span class="o">[</span><span class="n">&quot;create_building()&quot;</span><span class="o">]</span>
<span class="w">        </span><span class="n">G3</span><span class="o">[</span><span class="n">&quot;run_fem_analysis()&quot;</span><span class="o">]</span>
<span class="w">        </span><span class="n">G4</span><span class="o">[</span><span class="n">&quot;calculate_all_evaluations()&quot;</span><span class="o">]</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">subgraph</span><span class="w"> </span><span class="k">OUTPUT</span><span class="o">[</span><span class="n">&quot;出力&quot;</span><span class="o">]</span>
<span class="w">        </span><span class="n">O1</span><span class="o">[</span><span class="n">results辞書</span><span class="o">]</span>
<span class="w">        </span><span class="n">O2</span><span class="o">[</span><span class="n">FCStdファイル</span><span class="o">]</span>
<span class="w">        </span><span class="n">O3</span><span class="o">[</span><span class="n">CSVレコード</span><span class="o">]</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">P</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">T1</span>
<span class="w">    </span><span class="n">T1</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">T2</span>
<span class="w">    </span><span class="n">T2</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">G1</span>
<span class="w">    </span><span class="n">G1</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">G2</span>
<span class="w">    </span><span class="n">G2</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">G3</span>
<span class="w">    </span><span class="n">G3</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">G4</span>
<span class="w">    </span><span class="n">G4</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">O1</span>
<span class="w">    </span><span class="n">O1</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">T3</span>
<span class="w">    </span><span class="n">T3</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">O3</span>
<span class="w">    </span><span class="n">T3</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">T4</span>
<span class="w">    </span><span class="n">G2</span><span class="w"> </span><span class="o">--&gt;</span><span class="w"> </span><span class="n">O2</span>

<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">P</span><span class="w"> </span><span class="nl">fill</span><span class="p">:</span><span class="n">#e8f5e9</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">O1</span><span class="w"> </span><span class="nl">fill</span><span class="p">:</span><span class="n">#fce4ec</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">O2</span><span class="w"> </span><span class="nl">fill</span><span class="p">:</span><span class="n">#fce4ec</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">O3</span><span class="w"> </span><span class="nl">fill</span><span class="p">:</span><span class="n">#fce4ec</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">T2</span><span class="w"> </span><span class="nl">fill</span><span class="p">:</span><span class="n">#e3f2fd</span>
<span class="w">    </span><span class="n">style</span><span class="w"> </span><span class="n">G1</span><span class="w"> </span><span class="nl">fill</span><span class="p">:</span><span class="n">#fff3e0</span>
</code></pre></div>

<h3 id="_6">具体的な実装</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_generate_building.py の主要部分</span>
<span class="kn">from</span> <span class="nn">generate_building_fem_analyze</span> <span class="kn">import</span> <span class="n">evaluate_building_from_params</span>

<span class="c1"># デフォルトのテスト用パラメータ</span>
<span class="c1"># ※推奨値は建物のデザインが崩れず、構造的に妥当な範囲を示しています</span>
<span class="n">test_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># 建物寸法</span>
    <span class="s1">&#39;Lx&#39;</span><span class="p">:</span> <span class="mf">8.5</span><span class="p">,</span>           <span class="c1"># 建物幅 [m] (推奨値: [8.0, 12.0])</span>
    <span class="s1">&#39;Ly&#39;</span><span class="p">:</span> <span class="mf">9.0</span><span class="p">,</span>           <span class="c1"># 建物奥行 [m] (推奨値: [8.0, 12.0])</span>
    <span class="s1">&#39;H1&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>           <span class="c1"># 1階高さ [m] (推奨値: [2.6, 3.5])</span>
    <span class="s1">&#39;H2&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>           <span class="c1"># 2階高さ [m] (推奨値: [2.6, 3.5])</span>

    <span class="c1"># 構造部材寸法</span>
    <span class="s1">&#39;tf&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>           <span class="c1"># 床スラブ厚 [mm] (推奨値: [350, 600])</span>
    <span class="s1">&#39;tr&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>           <span class="c1"># 屋根スラブ厚 [mm] (推奨値: [350, 600])</span>
    <span class="s1">&#39;bc&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>           <span class="c1"># 柱幅 [mm] (推奨値: [400, 1000])</span>
    <span class="s1">&#39;hc&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>           <span class="c1"># 柱高さ [mm] (推奨値: [400, 1000])</span>
    <span class="s1">&#39;tw_ext&#39;</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span>       <span class="c1"># 外壁厚 [mm] (推奨値: [300, 500])</span>

    <span class="c1"># その他の設計パラメータ</span>
    <span class="s1">&#39;wall_tilt_angle&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">25</span><span class="p">,</span>      <span class="c1"># 壁傾斜角 [度] (推奨値: [-30.0, 30.0])</span>
    <span class="s1">&#39;window_ratio_2f&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>      <span class="c1"># 2階窓面積比 (推奨値: [0.1, 0.9])</span>
    <span class="s1">&#39;roof_morph&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>           <span class="c1"># 屋根形態 (推奨値: [0.0, 1.0])</span>
    <span class="s1">&#39;roof_shift&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>           <span class="c1"># 屋根シフト (推奨値: [-0.5, 0.5])</span>
    <span class="s1">&#39;balcony_depth&#39;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span>        <span class="c1"># バルコニー奥行 [m] (推奨値: [1.0, 3.5])</span>

    <span class="c1"># 材料パラメータ（0:コンクリート, 1:木材）</span>
    <span class="s1">&#39;material_columns&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>      <span class="c1"># 柱材料</span>
    <span class="s1">&#39;material_floor1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>       <span class="c1"># 1階床材料</span>
    <span class="s1">&#39;material_floor2&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>       <span class="c1"># 2階床材料</span>
    <span class="s1">&#39;material_roof&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="c1"># 屋根材料</span>
    <span class="s1">&#39;material_walls&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>        <span class="c1"># 外壁材料</span>
    <span class="s1">&#39;material_balcony&#39;</span><span class="p">:</span> <span class="mi">0</span>       <span class="c1"># バルコニー材料</span>
<span class="p">}</span>

<span class="c1"># コア解析エンジンを呼び出し</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">evaluate_building_from_params</span><span class="p">(</span>
    <span class="n">test_params</span><span class="p">,</span>
    <span class="n">save_fcstd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fcstd_path</span><span class="o">=</span><span class="n">fcstd_filename</span>
<span class="p">)</span>

<span class="c1"># 結果をCSVに保存</span>
<span class="n">save_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>

<p><strong>推奨値について</strong>：
- 推奨値は、建物のデザインが崩れず、構造的に妥当な結果が得られる範囲です
- この範囲内であれば、FEM解析が正常に実行され、現実的な建物形状が生成されます
- 推奨値外の値も設定可能ですが、極端な値では解析エラーや非現実的な形状になる可能性があります</p>
<h3 id="_7">なぜ分離されているか</h3>
<ol>
<li><strong>モジュール性</strong>: コア機能（generate_building_fem_analyze.py）を他のスクリプトからも利用可能</li>
<li><strong>テスト容易性</strong>: テストロジックと本体ロジックの分離</li>
<li><strong>拡張性</strong>: PSO.pyやrandom_building_sampler.pyなど，複数のスクリプトから同じエンジンを利用</li>
<li><strong>保守性</strong>: 各ファイルが単一の責務を持つことで管理が容易</li>
</ol>
<h2 id="_8">主な機能</h2>
<ul>
<li>単一サンプルの建物生成とFEM解析</li>
<li>結果の詳細表示（安全性，経済性，環境性，快適性，施工性）</li>
<li>CSV形式での結果保存（タイムスタンプ付きまたは固定ファイル名）</li>
<li>FCStdファイルの生成（タイムスタンプ付き）</li>
<li>FCBakファイルの自動削除機能</li>
<li>実行時間の計測</li>
</ul>
<h2 id="_9">実行方法</h2>
<h3 id="mac">Mac</h3>
<div class="codehilite"><pre><span></span><code>/Applications/FreeCAD.app/Contents/Resources/bin/freecadcmd<span class="w"> </span>test_generate_building.py
</code></pre></div>

<h3 id="windows">Windows</h3>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="s2">&quot;C:\Program Files\FreeCAD 1.0\bin\freecadcmd.exe&quot;</span><span class="w"> </span>test_generate_building.py
</code></pre></div>

<p><strong>注意</strong>: 上記のパスはお使いのPCの環境に合わせて調整してください．FreeCADのインストール先が異なる場合は，適切なパスに変更する必要があります．</p>
<h2 id="_10">パラメータ設定</h2>
<h3 id="_11">デフォルトパラメータ</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 建物寸法</span>
<span class="s1">&#39;Lx&#39;</span><span class="p">:</span> <span class="mf">8.5</span><span class="p">,</span>           <span class="c1"># 建物幅 [m] (推奨値: 8.0-12.0)</span>
<span class="s1">&#39;Ly&#39;</span><span class="p">:</span> <span class="mf">9.0</span><span class="p">,</span>           <span class="c1"># 建物奥行 [m] (推奨値: 8.0-12.0)</span>
<span class="s1">&#39;H1&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>           <span class="c1"># 1階高さ [m] (推奨値: 2.6-3.5)</span>
<span class="s1">&#39;H2&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>           <span class="c1"># 2階高さ [m] (推奨値: 2.6-3.5)</span>

<span class="c1"># 構造部材寸法</span>
<span class="s1">&#39;tf&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>           <span class="c1"># 床スラブ厚 [mm] (推奨値: 350-600)</span>
<span class="s1">&#39;tr&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>           <span class="c1"># 屋根スラブ厚 [mm] (推奨値: 350-600)</span>
<span class="s1">&#39;bc&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>           <span class="c1"># 柱幅 [mm] (推奨値: 400-1000)</span>
<span class="s1">&#39;hc&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>           <span class="c1"># 柱高さ [mm] (推奨値: 400-1000)</span>
<span class="s1">&#39;tw_ext&#39;</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span>       <span class="c1"># 外壁厚 [mm] (推奨値: 300-500)</span>

<span class="c1"># その他の設計パラメータ</span>
<span class="s1">&#39;wall_tilt_angle&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">25</span><span class="p">,</span>   <span class="c1"># 壁傾斜角 [度] (推奨値: -30.0～30.0)</span>
<span class="s1">&#39;window_ratio_2f&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>   <span class="c1"># 2階窓面積比 (推奨値: 0.1-0.9)</span>
<span class="s1">&#39;roof_morph&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>        <span class="c1"># 屋根形態 (推奨値: 0.0-1.0)</span>
<span class="s1">&#39;roof_shift&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>        <span class="c1"># 屋根シフト (推奨値: -0.5～0.5)</span>
<span class="s1">&#39;balcony_depth&#39;</span><span class="p">:</span> <span class="mf">1.8</span>      <span class="c1"># バルコニー奥行 [m] (推奨値: 1.0-3.5)</span>
</code></pre></div>

<h3 id="_12">材料パラメータ</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 0: コンクリート, 1: 木材</span>
<span class="s1">&#39;material_columns&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>    <span class="c1"># 柱材料</span>
<span class="s1">&#39;material_floor1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="c1"># 1階床材料</span>
<span class="s1">&#39;material_floor2&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="c1"># 2階床材料</span>
<span class="s1">&#39;material_roof&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>       <span class="c1"># 屋根材料</span>
<span class="s1">&#39;material_walls&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>      <span class="c1"># 外壁材料（木材）</span>
<span class="s1">&#39;material_balcony&#39;</span><span class="p">:</span> <span class="mi">0</span>     <span class="c1"># バルコニー材料</span>
</code></pre></div>

<h3 id="_13">パラメータの推奨範囲（デザインが崩れない範囲）</h3>
<p>以下は<code>random_building_sampler.py</code>で使用されている範囲で、建物のデザインが崩れず、構造的にも妥当な値の範囲です：</p>
<table>
<thead>
<tr>
<th>パラメータ</th>
<th>推奨最小値</th>
<th>推奨最大値</th>
<th>単位</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>建物寸法</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Lx</td>
<td>8.0</td>
<td>12.0</td>
<td>m</td>
<td>建物幅</td>
</tr>
<tr>
<td>Ly</td>
<td>8.0</td>
<td>12.0</td>
<td>m</td>
<td>建物奥行</td>
</tr>
<tr>
<td>H1</td>
<td>2.6</td>
<td>3.5</td>
<td>m</td>
<td>1階高さ（建築基準法準拠）</td>
</tr>
<tr>
<td>H2</td>
<td>2.6</td>
<td>3.5</td>
<td>m</td>
<td>2階高さ</td>
</tr>
<tr>
<td><strong>構造部材寸法</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tf</td>
<td>350</td>
<td>600</td>
<td>mm</td>
<td>床スラブ厚（安全率確保）</td>
</tr>
<tr>
<td>tr</td>
<td>350</td>
<td>600</td>
<td>mm</td>
<td>屋根スラブ厚</td>
</tr>
<tr>
<td>bc</td>
<td>400</td>
<td>1000</td>
<td>mm</td>
<td>柱幅（構造安定性）</td>
</tr>
<tr>
<td>hc</td>
<td>400</td>
<td>1000</td>
<td>mm</td>
<td>柱高さ（断面）</td>
</tr>
<tr>
<td>tw_ext</td>
<td>300</td>
<td>500</td>
<td>mm</td>
<td>外壁厚</td>
</tr>
<tr>
<td><strong>設計パラメータ</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>wall_tilt_angle</td>
<td>-30</td>
<td>30</td>
<td>度</td>
<td>壁傾斜角</td>
</tr>
<tr>
<td>window_ratio_2f</td>
<td>0.1</td>
<td>0.9</td>
<td>-</td>
<td>2階窓面積比</td>
</tr>
<tr>
<td>roof_morph</td>
<td>0.0</td>
<td>1.0</td>
<td>-</td>
<td>屋根形態（0:フラット、1:かまぼこ）</td>
</tr>
<tr>
<td>roof_shift</td>
<td>-0.5</td>
<td>0.5</td>
<td>-</td>
<td>屋根シフト</td>
</tr>
<tr>
<td>balcony_depth</td>
<td>1.0</td>
<td>3.5</td>
<td>m</td>
<td>バルコニー奥行</td>
</tr>
</tbody>
</table>
<p><strong>注意</strong>: 
- これらの範囲は構造的安定性とデザインの妥当性を考慮した推奨値です
- 学習目的でこれらの範囲外の値を試すことも可能ですが、極端な値では解析エラーや非現実的な結果になる可能性があります
- 特に構造部材寸法を推奨値より小さくすると、安全率が大幅に低下する可能性があります</p>
<h2 id="_14">出力ファイル</h2>
<h3 id="1-csv">1. CSVファイル</h3>
<ul>
<li><strong>ファイル名</strong>: <code>test_results.csv</code>（固定）</li>
<li><strong>動作</strong>: 既存ファイルに追記（ファイルが無い場合は新規作成）</li>
<li><strong>内容</strong>: </li>
<li>入力パラメータ（20項目）</li>
<li>評価結果（安全率，コスト，CO2，快適性，施工性）</li>
<li>実行情報（タイムスタンプ，実行時間，ステータス）</li>
</ul>
<h3 id="2-fcstd">2. FCStdファイル</h3>
<ul>
<li><strong>ファイル名</strong>: <code>test_building_YYYYMMDD_HHMMSS.FCStd</code>（タイムスタンプ付き）</li>
<li><strong>設定</strong>: <code>USE_TIMESTAMP_FOR_FCSTD = True</code>で制御可能</li>
<li><strong>内容</strong>: 生成された建物の3Dモデル（FreeCAD形式）</li>
<li><strong>開き方</strong>: </li>
<li>FreeCADアプリケーションで直接開くことができます</li>
<li>ファイル → 開く → FCStdファイルを選択</li>
<li>または、FCStdファイルをダブルクリック（FreeCADがインストールされている場合）</li>
<li><strong>FCStdファイルとは</strong>: </li>
<li>FreeCADの標準ファイル形式（FreeCAD Standard Document）</li>
<li>3Dモデル、FEM解析設定、材料情報などすべてのデータを含む</li>
<li>圧縮されたXML形式で、実際にはZIPアーカイブ</li>
<li>他のCADソフトへのエクスポート（STEP、IGES、STL等）も可能</li>
</ul>
<h2 id="_15">出力例</h2>
<div class="codehilite"><pre><span></span><code>=== 建物評価テスト実行開始 ===

入力パラメータ:
  Lx: 8.5
  Ly: 9.0
  H1: 3.0
  H2: 3.0
  tf: 400
  tr: 450
  bc: 450
  hc: 450
  tw_ext: 350
  wall_tilt_angle: -25
  window_ratio_2f: 0.7
  roof_morph: 0.9
  roof_shift: 0.4
  balcony_depth: 1.8
  material_columns: 0 (コンクリート)
  material_floor1: 0 (コンクリート)
  material_floor2: 0 (コンクリート)
  material_roof: 0 (コンクリート)
  material_walls: 1 (木材)
  material_balcony: 0 (コンクリート)

解析実行中...

=== 解析結果 ===

【安全性】
  安全率: 1.079
  最大変位: 8.116 mm
  最大応力: 32.433 MPa

【経済性】
  建設コスト: 618,276 円/㎡
  総工費: 47,298,095 円

【環境性】
  CO2排出量: 1571.2 kg-CO2/㎡
  最適化ポテンシャル: 25.0%

【快適性】
  快適性スコア: 5.86/10
    空間の広がり: 0.50
    採光・眺望: 7.45
    開放感: -1.50
    プライバシー: 4.00

【施工性】
  施工性スコア: 4.25/10

✅ 結果をCSVファイルに保存しました: test_results.csv
🗑️ 生成された.FCBakファイルを削除中...
   削除: test_building_20250810_132410.FCBak
✅ 1個の.FCBakファイルを削除しました

=== テスト完了 ===
</code></pre></div>

<h3 id="_16">テスト実行方法</h3>
<h4 id="mac_1">Mac</h4>
<div class="codehilite"><pre><span></span><code>/Applications/FreeCAD.app/Contents/Resources/bin/freecadcmd<span class="w"> </span>test_generate_building.py
</code></pre></div>

<h4 id="windows_1">Windows</h4>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="s2">&quot;C:\Program Files\FreeCAD 1.0\bin\freecadcmd.exe&quot;</span><span class="w"> </span>test_generate_building.py
</code></pre></div>

<p><strong>注意</strong>: 上記のパスはお使いのPCの環境に合わせて調整してください．</p>
<h3 id="_17">出力データ</h3>
<p><code>test_results.csv</code>には以下の情報が記録されます（ファイルが存在しない場合は自動作成，既存の場合は追記）：</p>
<p>• <strong>設計パラメータ（20個）</strong></p>
<table>
<thead>
<tr>
<th>カテゴリ</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>基本形状</td>
<td>建物幅，奥行，各階高さ</td>
</tr>
<tr>
<td>構造寸法</td>
<td>床・屋根スラブ厚，柱サイズ，壁厚</td>
</tr>
<tr>
<td>追加要素</td>
<td>壁傾斜角，窓面積比，屋根形状，バルコニー奥行</td>
</tr>
<tr>
<td>材料選択</td>
<td>各部位の材料（0:コンクリート，1:木材）</td>
</tr>
</tbody>
</table>
<p>• <strong>評価指標（5項目）</strong></p>
<table>
<thead>
<tr>
<th>評価項目</th>
<th>説明</th>
<th>単位</th>
</tr>
</thead>
<tbody>
<tr>
<td>安全率</td>
<td>FEM解析による構造安全性</td>
<td>-</td>
</tr>
<tr>
<td>コスト</td>
<td>建設費用</td>
<td>円/m²</td>
</tr>
<tr>
<td>CO2排出量</td>
<td>環境負荷</td>
<td>kg-CO2/m²</td>
</tr>
<tr>
<td>快適性スコア</td>
<td>空間品質評価</td>
<td>0-10</td>
</tr>
<tr>
<td>施工性スコア</td>
<td>施工難易度評価</td>
<td>0-10</td>
</tr>
</tbody>
</table>
<p>• <strong>実行メタデータ</strong></p>
<ul>
<li>タイムスタンプ: 実行日時</li>
<li>処理時間: 評価に要した時間 [秒]</li>
<li>FCStdファイルパス: 生成された3Dモデルファイル</li>
</ul>
<hr />
<h2 id="_18">システム構成と関係図</h2>
<h3 id="_19">データフローの詳細</h3>
<div class="codehilite"><pre><span></span><code><span class="n">sequenceDiagram</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="err">ユーザー</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="n">test_generate_building</span><span class="p">.</span><span class="n">py</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">Core</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="n">generate_building_fem_analyze</span><span class="p">.</span><span class="n">py</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">FC</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="n">FreeCAD</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">CCX</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="n">CalculiX</span>

<span class="w">    </span><span class="n">User</span><span class="o">-&gt;&gt;</span><span class="n">Test</span><span class="o">:</span><span class="w"> </span><span class="err">実行コマンド</span>
<span class="w">    </span><span class="n">Test</span><span class="o">-&gt;&gt;</span><span class="n">Test</span><span class="o">:</span><span class="w"> </span><span class="err">パラメータ準備（</span><span class="mi">20</span><span class="err">個）</span>
<span class="w">    </span><span class="n">Test</span><span class="o">-&gt;&gt;</span><span class="n">Core</span><span class="o">:</span><span class="w"> </span><span class="n">evaluate_building_from_params</span><span class="p">()</span>

<span class="w">    </span><span class="n">Core</span><span class="o">-&gt;&gt;</span><span class="n">FC</span><span class="o">:</span><span class="w"> </span><span class="mi">3</span><span class="n">Dモデル生成</span>
<span class="w">    </span><span class="n">FC</span><span class="o">--&gt;&gt;</span><span class="n">Core</span><span class="o">:</span><span class="w"> </span><span class="n">Partオブジェクト</span>

<span class="w">    </span><span class="n">Core</span><span class="o">-&gt;&gt;</span><span class="n">Core</span><span class="o">:</span><span class="w"> </span><span class="err">メッシュ生成</span>
<span class="w">    </span><span class="n">Core</span><span class="o">-&gt;&gt;</span><span class="n">CCX</span><span class="o">:</span><span class="w"> </span><span class="n">FEM解析実行</span>
<span class="w">    </span><span class="n">CCX</span><span class="o">--&gt;&gt;</span><span class="n">Core</span><span class="o">:</span><span class="w"> </span><span class="err">応力・変位結果</span>

<span class="w">    </span><span class="n">Core</span><span class="o">-&gt;&gt;</span><span class="n">Core</span><span class="o">:</span><span class="w"> </span><span class="err">評価指標計算</span>
<span class="w">    </span><span class="n">Note</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">Core</span><span class="o">:</span><span class="w"> </span><span class="err">安全性，経済性，</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">環境性，快適性，</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span><span class="err">施工性</span>

<span class="w">    </span><span class="n">Core</span><span class="o">--&gt;&gt;</span><span class="n">Test</span><span class="o">:</span><span class="w"> </span><span class="n">results辞書</span>
<span class="w">    </span><span class="n">Test</span><span class="o">-&gt;&gt;</span><span class="n">Test</span><span class="o">:</span><span class="w"> </span><span class="err">結果整形</span>
<span class="w">    </span><span class="n">Test</span><span class="o">-&gt;&gt;</span><span class="n">User</span><span class="o">:</span><span class="w"> </span><span class="err">コンソール表示</span>
<span class="w">    </span><span class="n">Test</span><span class="o">-&gt;&gt;</span><span class="n">Test</span><span class="o">:</span><span class="w"> </span><span class="n">CSV追記</span>
<span class="w">    </span><span class="n">Core</span><span class="o">-&gt;&gt;</span><span class="n">FC</span><span class="o">:</span><span class="w"> </span><span class="n">FCStd保存</span>
<span class="w">    </span><span class="n">Test</span><span class="o">-&gt;&gt;</span><span class="n">Test</span><span class="o">:</span><span class="w"> </span><span class="n">FCBakファイル削除</span>
</code></pre></div>

<h2 id="_20">注意事項</h2>
<ol>
<li>FreeCADのコマンドライン版（freecadcmd）で実行する必要があります</li>
<li><code>generate_building_fem_analyze.py</code>が同じディレクトリに存在する必要があります</li>
<li>CalculiXがインストールされている必要があります（FEM解析用）</li>
<li>実行時間は通常2〜5秒程度ですが，複雑な形状では長くなることがあります</li>
<li>FCBakファイルは実行ごとに自動的に削除されます（ディスク容量の節約）</li>
</ol>
<h2 id="_21">トラブルシューティング</h2>
<h3 id="modulenotfounderror">ModuleNotFoundError</h3>
<p>親ディレクトリにFem.pyなどの競合するファイルがある場合，モジュールの読み込みエラーが発生することがあります．このスクリプトは現在のディレクトリのみをPythonパスに追加するよう設計されています．</p>
<h3 id="fem">FEM解析エラー</h3>
<p>メッシュ生成やソルバー実行でエラーが発生した場合，VERBOSE_OUTPUTを有効にして詳細なエラー情報を確認してください．</p>
<h3 id="csv">CSV出力エラー</h3>
<p>ファイルが他のプログラムで開かれている場合，書き込みエラーが発生します．CSVファイルを閉じてから再実行してください．</p>
</body>
</html>