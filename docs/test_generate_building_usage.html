<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`test_generate_building.py` 使用ガイド</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">
    <!-- Mermaidを先に読み込み、即座に初期化 -->
    <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        // Mermaidを即座に初期化（MathJaxより先に処理）
        mermaid.initialize({ 
            startOnLoad: true,
            logLevel: 'error'
        });
    </script>
    
    <!-- MathJax for LaTeX (Mermaidの後に読み込み) -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\(', '\)']],
                displayMath: [['$$', '$$'], ['\[', '\]']]
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'annotation', 'annotation-xml'],
                processHtmlClass: 'tex2jax_process',
                ignoreHtmlClass: 'mermaid|tex2jax_ignore'  // Mermaidブロックを無視
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 280px;
            background-color: #f6f8fa;
            border-right: 1px solid #e1e4e8;
            padding: 20px;
            overflow-y: auto;
            position: fixed;
            height: 100vh;
            box-sizing: border-box;
        }
        .sidebar h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #24292e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
        }
        .sidebar > ul > li {
            margin-bottom: 8px;
        }
        .sidebar ul ul {
            margin-left: 16px;
            margin-top: 4px;
        }
        .sidebar a {
            color: #0366d6;
            text-decoration: none;
            font-size: 14px;
            display: block;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .sidebar a:hover {
            background-color: #e1e4e8;
        }
        .sidebar a.active {
            background-color: #0366d6;
            color: white;
        }
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 40px;
            max-width: 980px;
            box-sizing: border-box;
        }
        .markdown-body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
        }
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: #0366d6;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            cursor: pointer;
        }
        .back-to-top.visible {
            opacity: 0.9;
        }
        .back-to-top:hover {
            opacity: 1;
        }
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="sidebar">
            <h3>📑 目次</h3>
            <ul><li><a href="#概要">概要</a></li><li><a href="#システム全体の流れ">システム全体の流れ</a></li><li><a href="#入力パラメータ20個の詳細">入力パラメータ（20個）の詳細</a></li><li><a href="#出力評価指標5項目の詳細">出力評価指標（5項目）の詳細</a></li><li><a href="#2つのスクリプトの関係性">2つのスクリプトの関係性</a></li><li><a href="#主な機能">主な機能</a></li><li><a href="#実行方法">実行方法</a></li><li><a href="#パラメータ設定">パラメータ設定</a></li><li><a href="#出力ファイル">出力ファイル</a></li><li><a href="#出力例">出力例</a></li><li><a href="#システム構成と関係図">システム構成と関係図</a></li><li><a href="#注意事項">注意事項</a></li><li><a href="#トラブルシューティング">トラブルシューティング</a></li></ul>
            
            <h3>📁 その他のドキュメント</h3>
            <ul>
                <li><a href="index.html">📚 ドキュメントホーム</a></li>
                <li><a href="generate_building_fem_analyze_report.html">📊 FEM解析システム</a></li>
                <li><a href="test_generate_building_usage.html">🧪 テストツール</a></li>
                <li><a href="PSO_usage.html">🚀 PSO使用ガイド</a></li>
            </ul>
            
            <h3>🔗 リンク</h3>
            <ul>
                <li><a href="https://github.com/jkushida/ai-arch" target="_blank">GitHub →</a></li>
            </ul>
        </nav>
        
        <main class="main-content">
            <article class="markdown-body">
                <h1><code>test_generate_building.py</code> 使用ガイド</h1>
<h2 id="概要">概要</h2>
<p><code>test_generate_building.py</code>は，<code>generate_building_fem_analyze.py</code>の動作確認を目的としたテストスクリプトです．指定したパラメータで建物を生成し，FEM解析を実行して結果を表示・保存します．</p>
<h2 id="システム全体の流れ">システム全体の流れ</h2>
<h3 id="パラメータと評価指標の流れ">パラメータと評価指標の流れ</h3>
<div class="mermaid">
graph LR
    subgraph "入力パラメータ（20個）"
        P1["形状パラメータ<br/>14個<br/>(連続値)"]
        P2["材料パラメータ<br/>6個<br/>(離散値)"]
    end
    
    subgraph "処理  generate_building_fem_analyze.py"
        M1["3Dモデル生成<br/>create_building()"]
        M2["FEM解析<br/>run_fem_analysis()"]
        M3["指標計算<br/>calculate_all_evaluations()"]
    end
    
    subgraph "出力評価指標"
        R1["安全性"]
        R2["経済性"]
        R3["環境性"]
        R4["快適性"]
        R5["施工性"]
    end
    
    P1 --> M1
    P2 --> M1
    M1 --> M2
    M2 --> M3
    M3 --> R1
    M3 --> R2
    M3 --> R3
    M3 --> R4
    M3 --> R5
    
    style P1 fill:#e8f5e9
    style P2 fill:#e8f5e9
    style R1 fill:#ffebee
    style R2 fill:#fff3e0
    style R3 fill:#e8f5e9
    style R4 fill:#e3f2fd
    style R5 fill:#f3e5f5
</div>

<h2 id="入力パラメータ20個の詳細">入力パラメータ（20個）の詳細</h2>
<h3 id="形状パラメータ14個--すべて連続値">形状パラメータ（14個）- すべて連続値</h3>
<h4>建物寸法（4個）</h4>
<table>
<thead>
<tr>
<th>パラメータ名</th>
<th>説明</th>
<th>型・範囲</th>
<th>単位</th>
</tr>
</thead>
<tbody>
<tr>
<td>Lx</td>
<td>建物幅</td>
<td>実数値</td>
<td>m</td>
</tr>
<tr>
<td>Ly</td>
<td>建物奥行</td>
<td>実数値</td>
<td>m</td>
</tr>
<tr>
<td>H1</td>
<td>1階高さ</td>
<td>実数値</td>
<td>m</td>
</tr>
<tr>
<td>H2</td>
<td>2階高さ</td>
<td>実数値</td>
<td>m</td>
</tr>
</tbody>
</table>
<h4>構造部材（5個）</h4>
<table>
<thead>
<tr>
<th>パラメータ名</th>
<th>説明</th>
<th>型・範囲</th>
<th>単位</th>
</tr>
</thead>
<tbody>
<tr>
<td>tf</td>
<td>床スラブ厚</td>
<td>実数値</td>
<td>mm</td>
</tr>
<tr>
<td>tr</td>
<td>屋根スラブ厚</td>
<td>実数値</td>
<td>mm</td>
</tr>
<tr>
<td>bc</td>
<td>柱幅</td>
<td>実数値</td>
<td>mm</td>
</tr>
<tr>
<td>hc</td>
<td>柱高さ（断面）</td>
<td>実数値</td>
<td>mm</td>
</tr>
<tr>
<td>tw_ext</td>
<td>外壁厚</td>
<td>実数値</td>
<td>mm</td>
</tr>
</tbody>
</table>
<h4>設計特性（5個）</h4>
<table>
<thead>
<tr>
<th>パラメータ名</th>
<th>説明</th>
<th>型・範囲</th>
<th>単位</th>
</tr>
</thead>
<tbody>
<tr>
<td>wall_tilt_angle</td>
<td>壁傾斜角</td>
<td>実数値</td>
<td>度</td>
</tr>
<tr>
<td>window_ratio_2f</td>
<td>2階窓面積比</td>
<td>0.0～1.0</td>
<td>-</td>
</tr>
<tr>
<td>roof_morph</td>
<td>屋根形態（0:フラット，1:かまぼこ）</td>
<td>0.0～1.0</td>
<td>-</td>
</tr>
<tr>
<td>roof_shift</td>
<td>屋根シフト</td>
<td>-1.0～1.0</td>
<td>-</td>
</tr>
<tr>
<td>balcony_depth</td>
<td>バルコニー奥行</td>
<td>実数値</td>
<td>m</td>
</tr>
</tbody>
</table>
<h3 id="材料パラメータ6個--離散値">材料パラメータ（6個）- 離散値</h3>
<table>
<thead>
<tr>
<th>パラメータ名</th>
<th>値</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>material_columns</td>
<td>0 or 1</td>
<td>柱材料（0:コンクリート，1:木材）</td>
</tr>
<tr>
<td>material_floor1</td>
<td>0 or 1</td>
<td>1階床材料（0:コンクリート，1:木材）</td>
</tr>
<tr>
<td>material_floor2</td>
<td>0 or 1</td>
<td>2階床材料（0:コンクリート，1:木材）</td>
</tr>
<tr>
<td>material_roof</td>
<td>0 or 1</td>
<td>屋根材料（0:コンクリート，1:木材）</td>
</tr>
<tr>
<td>material_walls</td>
<td>0 or 1</td>
<td>外壁材料（0:コンクリート，1:木材）</td>
</tr>
<tr>
<td>material_balcony</td>
<td>0 or 1</td>
<td>バルコニー材料（0:コンクリート，1:木材）</td>
</tr>
</tbody>
</table>
<h2 id="出力評価指標5項目の詳細">出力評価指標（5項目）の詳細</h2>
<table>
<thead>
<tr>
<th>評価項目</th>
<th>説明</th>
<th>単位</th>
<th>良好な値</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>安全率</strong></td>
<td>FEM解析による構造安全性</td>
<td>-</td>
<td>&gt; 2.0</td>
</tr>
<tr>
<td><strong>コスト</strong></td>
<td>建設費用</td>
<td>円/m²</td>
<td>&lt; 500,000</td>
</tr>
<tr>
<td><strong>CO2排出量</strong></td>
<td>環境負荷</td>
<td>kg-CO2/m²</td>
<td>低いほど良い</td>
</tr>
<tr>
<td><strong>快適性スコア</strong></td>
<td>空間品質評価</td>
<td>0-10</td>
<td>&gt; 6.0</td>
</tr>
<tr>
<td><strong>施工性スコア</strong></td>
<td>施工難易度評価</td>
<td>0-10</td>
<td>&gt; 6.0</td>
</tr>
</tbody>
</table>
<p><strong>⚠️ 重要な注意事項</strong>：</p>
<ul>
<li>FEM解析（有限要素法）の内部処理では、メッシュ生成時に乱数を使用しています</li>
<li>そのため、<strong>同じパラメータでも実行するたびに安全率などの値がある程度変動します</strong></li>
<li>変動幅は通常±10〜20%程度ですが、複雑な形状では変動が大きくなることがあります</li>
</ul>
<h2 id="2つのスクリプトの関係性">2つのスクリプトの関係性</h2>
<h3 id="役割分担">役割分担</h3>
<h4>🧪 <code>test_generate_building.py</code>（テストスクリプト）</h4>
<ul>
<li><strong>役割</strong>: コア解析エンジンのテストとデバッグ</li>
<li><strong>責務</strong>:</li>
<li>テスト用パラメータの準備</li>
<li>解析エンジンの呼び出し（evaluate_building_from_params関数）</li>
<li>結果の整形と表示</li>
<li>CSVファイルへの記録</li>
<li>FCBakファイルの自動削除（FreeCADの自動バックアップファイルをクリーンアップ）</li>
<li><strong>特徴</strong>: シンプルで単一パラメータセットの評価に特化</li>
</ul>
<h4>⚙️ <code>generate_building_fem_analyze.py</code>（コア解析エンジン）</h4>
<ul>
<li><strong>役割</strong>: 建物生成とFEM解析の実行</li>
<li><strong>責務</strong>:</li>
<li>3D建物モデルの生成</li>
<li>FEM解析の実行</li>
<li>評価指標の計算</li>
<li>FCStdファイルの保存</li>
<li><strong>特徴</strong>: 再利用可能な関数（evaluate_building_from_params）として提供</li>
</ul>
<h3 id="データの流れ">データの流れ</h3>
<div class="mermaid">
graph TB
    subgraph INPUT["入力"]
        P[20個のパラメータ<br/>辞書形式]
    end
    
    subgraph TEST["test_generate_building.py　　　　"]
        T1[パラメータ準備]
        T2[evaluate_building_from_params呼び出し]
        T3[結果処理とCSV保存]
        T4[FCBakファイル削除]
    end
    
    subgraph CORE["generate_building_fem_analyze.py　　　　"]
        G1[evaluate_building_from_params関数]
        G2["create_building()"]
        G3["run_fem_analysis()"]
        G4["calculate_all_evaluations()"]
    end
    
    subgraph OUTPUT["出力"]
        O1[results辞書]
        O2[FCStdファイル]
        O3[CSVレコード]
    end
    
    P --> T1
    T1 --> T2
    T2 --> G1
    G1 --> G2
    G2 --> G3
    G3 --> G4
    G4 --> O1
    O1 --> T3
    T3 --> O3
    T3 --> T4
    G2 --> O2
    
    style P fill:#e8f5e9
    style O1 fill:#fce4ec
    style O2 fill:#fce4ec
    style O3 fill:#fce4ec
    style T2 fill:#e3f2fd
    style G1 fill:#fff3e0
</div>

<h3 id="具体的な実装">具体的な実装</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># test_generate_building.py の主要部分</span>
<span class="kn">from</span> <span class="nn">generate_building_fem_analyze</span> <span class="kn">import</span> <span class="n">evaluate_building_from_params</span>

<span class="c1"># デフォルトのテスト用パラメータ</span>
<span class="c1"># ※推奨値は建物のデザインが崩れず、構造的に妥当な範囲を示しています</span>
<span class="n">test_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># 建物寸法</span>
    <span class="s1">&#39;Lx&#39;</span><span class="p">:</span> <span class="mf">8.5</span><span class="p">,</span>           <span class="c1"># 建物幅 [m] (推奨値: [8.0, 12.0])</span>
    <span class="s1">&#39;Ly&#39;</span><span class="p">:</span> <span class="mf">9.0</span><span class="p">,</span>           <span class="c1"># 建物奥行 [m] (推奨値: [8.0, 12.0])</span>
    <span class="s1">&#39;H1&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>           <span class="c1"># 1階高さ [m] (推奨値: [2.6, 3.5])</span>
    <span class="s1">&#39;H2&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>           <span class="c1"># 2階高さ [m] (推奨値: [2.6, 3.5])</span>

    <span class="c1"># 構造部材寸法</span>
    <span class="s1">&#39;tf&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>           <span class="c1"># 床スラブ厚 [mm] (推奨値: [350, 600])</span>
    <span class="s1">&#39;tr&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>           <span class="c1"># 屋根スラブ厚 [mm] (推奨値: [350, 600])</span>
    <span class="s1">&#39;bc&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>           <span class="c1"># 柱幅 [mm] (推奨値: [400, 1000])</span>
    <span class="s1">&#39;hc&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>           <span class="c1"># 柱高さ [mm] (推奨値: [400, 1000])</span>
    <span class="s1">&#39;tw_ext&#39;</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span>       <span class="c1"># 外壁厚 [mm] (推奨値: [300, 500])</span>

    <span class="c1"># その他の設計パラメータ</span>
    <span class="s1">&#39;wall_tilt_angle&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">25</span><span class="p">,</span>      <span class="c1"># 壁傾斜角 [度] (推奨値: [-30.0, 30.0])</span>
    <span class="s1">&#39;window_ratio_2f&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>      <span class="c1"># 2階窓面積比 (推奨値: [0.1, 0.9])</span>
    <span class="s1">&#39;roof_morph&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>           <span class="c1"># 屋根形態 (推奨値: [0.0, 1.0])</span>
    <span class="s1">&#39;roof_shift&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>           <span class="c1"># 屋根シフト (推奨値: [-0.5, 0.5])</span>
    <span class="s1">&#39;balcony_depth&#39;</span><span class="p">:</span> <span class="mf">1.8</span><span class="p">,</span>        <span class="c1"># バルコニー奥行 [m] (推奨値: [1.0, 3.5])</span>

    <span class="c1"># 材料パラメータ（0:コンクリート, 1:木材）</span>
    <span class="s1">&#39;material_columns&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>      <span class="c1"># 柱材料</span>
    <span class="s1">&#39;material_floor1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>       <span class="c1"># 1階床材料</span>
    <span class="s1">&#39;material_floor2&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>       <span class="c1"># 2階床材料</span>
    <span class="s1">&#39;material_roof&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="c1"># 屋根材料</span>
    <span class="s1">&#39;material_walls&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>        <span class="c1"># 外壁材料</span>
    <span class="s1">&#39;material_balcony&#39;</span><span class="p">:</span> <span class="mi">0</span>       <span class="c1"># バルコニー材料</span>
<span class="p">}</span>

<span class="c1"># コア解析エンジンを呼び出し</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">evaluate_building_from_params</span><span class="p">(</span>
    <span class="n">test_params</span><span class="p">,</span>
    <span class="n">save_fcstd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">fcstd_path</span><span class="o">=</span><span class="n">fcstd_filename</span>
<span class="p">)</span>

<span class="c1"># 結果をCSVに保存</span>
<span class="n">save_to_csv</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div>

<h3 id="なぜ分離されているか">なぜ分離されているか</h3>
<ol>
<li><strong>モジュール性</strong>: コア機能（generate_building_fem_analyze.py）を他のスクリプトからも利用可能</li>
<li><strong>テスト容易性</strong>: テストロジックと本体ロジックの分離</li>
<li><strong>拡張性</strong>: PSO.pyやrandom_building_sampler.pyなど，複数のスクリプトから同じエンジンを利用</li>
<li><strong>保守性</strong>: 各ファイルが単一の責務を持つことで管理が容易</li>
</ol>
<h2 id="主な機能">主な機能</h2>
<ul>
<li>単一サンプルの建物生成とFEM解析</li>
<li>結果の詳細表示（安全性，経済性，環境性，快適性，施工性）</li>
<li>CSV形式での結果保存（タイムスタンプ付きまたは固定ファイル名）</li>
<li>FCStdファイルの生成（タイムスタンプ付き）</li>
<li>FCBakファイルの自動削除機能</li>
<li>実行時間の計測</li>
</ul>
<h2 id="実行方法">実行方法</h2>
<h3 id="mac">Mac</h3>
<div class="codehilite"><pre><span></span><code>/Applications/FreeCAD.app/Contents/Resources/bin/freecadcmd<span class="w"> </span>test_generate_building.py
</code></pre></div>

<h3 id="windows">Windows</h3>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="s2">&quot;C:\Program Files\FreeCAD 1.0\bin\freecadcmd.exe&quot;</span><span class="w"> </span>test_generate_building.py
</code></pre></div>

<p><strong>注意</strong>: 上記のパスはお使いのPCの環境に合わせて調整してください．FreeCADのインストール先が異なる場合は，適切なパスに変更する必要があります．</p>
<h2 id="パラメータ設定">パラメータ設定</h2>
<h3 id="デフォルトパラメータ">デフォルトパラメータ</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 建物寸法</span>
<span class="s1">&#39;Lx&#39;</span><span class="p">:</span> <span class="mf">8.5</span><span class="p">,</span>           <span class="c1"># 建物幅 [m] (推奨値: 8.0-12.0)</span>
<span class="s1">&#39;Ly&#39;</span><span class="p">:</span> <span class="mf">9.0</span><span class="p">,</span>           <span class="c1"># 建物奥行 [m] (推奨値: 8.0-12.0)</span>
<span class="s1">&#39;H1&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>           <span class="c1"># 1階高さ [m] (推奨値: 2.6-3.5)</span>
<span class="s1">&#39;H2&#39;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>           <span class="c1"># 2階高さ [m] (推奨値: 2.6-3.5)</span>

<span class="c1"># 構造部材寸法</span>
<span class="s1">&#39;tf&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>           <span class="c1"># 床スラブ厚 [mm] (推奨値: 350-600)</span>
<span class="s1">&#39;tr&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>           <span class="c1"># 屋根スラブ厚 [mm] (推奨値: 350-600)</span>
<span class="s1">&#39;bc&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>           <span class="c1"># 柱幅 [mm] (推奨値: 400-1000)</span>
<span class="s1">&#39;hc&#39;</span><span class="p">:</span> <span class="mi">450</span><span class="p">,</span>           <span class="c1"># 柱高さ [mm] (推奨値: 400-1000)</span>
<span class="s1">&#39;tw_ext&#39;</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span>       <span class="c1"># 外壁厚 [mm] (推奨値: 300-500)</span>

<span class="c1"># その他の設計パラメータ</span>
<span class="s1">&#39;wall_tilt_angle&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">25</span><span class="p">,</span>   <span class="c1"># 壁傾斜角 [度] (推奨値: -30.0～30.0)</span>
<span class="s1">&#39;window_ratio_2f&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>   <span class="c1"># 2階窓面積比 (推奨値: 0.1-0.9)</span>
<span class="s1">&#39;roof_morph&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>        <span class="c1"># 屋根形態 (推奨値: 0.0-1.0)</span>
<span class="s1">&#39;roof_shift&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>        <span class="c1"># 屋根シフト (推奨値: -0.5～0.5)</span>
<span class="s1">&#39;balcony_depth&#39;</span><span class="p">:</span> <span class="mf">1.8</span>      <span class="c1"># バルコニー奥行 [m] (推奨値: 1.0-3.5)</span>
</code></pre></div>

<h3 id="材料パラメータ">材料パラメータ</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 0: コンクリート, 1: 木材</span>
<span class="s1">&#39;material_columns&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>    <span class="c1"># 柱材料</span>
<span class="s1">&#39;material_floor1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="c1"># 1階床材料</span>
<span class="s1">&#39;material_floor2&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>     <span class="c1"># 2階床材料</span>
<span class="s1">&#39;material_roof&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>       <span class="c1"># 屋根材料</span>
<span class="s1">&#39;material_walls&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>      <span class="c1"># 外壁材料（木材）</span>
<span class="s1">&#39;material_balcony&#39;</span><span class="p">:</span> <span class="mi">0</span>     <span class="c1"># バルコニー材料</span>
</code></pre></div>

<h3 id="パラメータの推奨範囲デザインが崩れない範囲">パラメータの推奨範囲（デザインが崩れない範囲）</h3>
<p>以下は<code>random_building_sampler.py</code>で使用されている範囲で、建物のデザインが崩れず、構造的にも妥当な値の範囲です：</p>
<table>
<thead>
<tr>
<th>パラメータ</th>
<th>推奨最小値</th>
<th>推奨最大値</th>
<th>単位</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>建物寸法</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Lx</td>
<td>8.0</td>
<td>12.0</td>
<td>m</td>
<td>建物幅</td>
</tr>
<tr>
<td>Ly</td>
<td>8.0</td>
<td>12.0</td>
<td>m</td>
<td>建物奥行</td>
</tr>
<tr>
<td>H1</td>
<td>2.6</td>
<td>3.5</td>
<td>m</td>
<td>1階高さ（建築基準法準拠）</td>
</tr>
<tr>
<td>H2</td>
<td>2.6</td>
<td>3.5</td>
<td>m</td>
<td>2階高さ</td>
</tr>
<tr>
<td><strong>構造部材寸法</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>tf</td>
<td>350</td>
<td>600</td>
<td>mm</td>
<td>床スラブ厚（安全率確保）</td>
</tr>
<tr>
<td>tr</td>
<td>350</td>
<td>600</td>
<td>mm</td>
<td>屋根スラブ厚</td>
</tr>
<tr>
<td>bc</td>
<td>400</td>
<td>1000</td>
<td>mm</td>
<td>柱幅（構造安定性）</td>
</tr>
<tr>
<td>hc</td>
<td>400</td>
<td>1000</td>
<td>mm</td>
<td>柱高さ（断面）</td>
</tr>
<tr>
<td>tw_ext</td>
<td>300</td>
<td>500</td>
<td>mm</td>
<td>外壁厚</td>
</tr>
<tr>
<td><strong>設計パラメータ</strong></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>wall_tilt_angle</td>
<td>-30</td>
<td>30</td>
<td>度</td>
<td>壁傾斜角</td>
</tr>
<tr>
<td>window_ratio_2f</td>
<td>0.1</td>
<td>0.9</td>
<td>-</td>
<td>2階窓面積比</td>
</tr>
<tr>
<td>roof_morph</td>
<td>0.0</td>
<td>1.0</td>
<td>-</td>
<td>屋根形態（0:フラット、1:かまぼこ）</td>
</tr>
<tr>
<td>roof_shift</td>
<td>-0.5</td>
<td>0.5</td>
<td>-</td>
<td>屋根シフト</td>
</tr>
<tr>
<td>balcony_depth</td>
<td>1.0</td>
<td>3.5</td>
<td>m</td>
<td>バルコニー奥行</td>
</tr>
</tbody>
</table>
<p><strong>注意</strong>: 
- これらの範囲は構造的安定性とデザインの妥当性を考慮した推奨値です
- 学習目的でこれらの範囲外の値を試すことも可能ですが、極端な値では解析エラーや非現実的な結果になる可能性があります
- 特に構造部材寸法を推奨値より小さくすると、安全率が大幅に低下する可能性があります</p>
<h2 id="出力ファイル">出力ファイル</h2>
<h3 id="1-csvファイル">1. CSVファイル</h3>
<ul>
<li><strong>ファイル名</strong>: <code>test_results.csv</code>（固定）</li>
<li><strong>動作</strong>: 既存ファイルに追記（ファイルが無い場合は新規作成）</li>
<li><strong>内容</strong>: </li>
<li>入力パラメータ（20項目）</li>
<li>評価結果（安全率，コスト，CO2，快適性，施工性）</li>
<li>実行情報（タイムスタンプ，実行時間，ステータス）</li>
</ul>
<h3 id="2-fcstdファイル">2. FCStdファイル</h3>
<ul>
<li><strong>ファイル名</strong>: <code>test_building_YYYYMMDD_HHMMSS.FCStd</code>（タイムスタンプ付き）</li>
<li><strong>設定</strong>: <code>USE_TIMESTAMP_FOR_FCSTD = True</code>で制御可能</li>
<li><strong>内容</strong>: 生成された建物の3Dモデル（FreeCAD形式）</li>
<li><strong>開き方</strong>: </li>
<li>FreeCADアプリケーションで直接開くことができます</li>
<li>ファイル → 開く → FCStdファイルを選択</li>
<li>または、FCStdファイルをダブルクリック（FreeCADがインストールされている場合）</li>
<li><strong>FCStdファイルとは</strong>: </li>
<li>FreeCADの標準ファイル形式（FreeCAD Standard Document）</li>
<li>3Dモデル、FEM解析設定、材料情報などすべてのデータを含む</li>
<li>圧縮されたXML形式で、実際にはZIPアーカイブ</li>
<li>他のCADソフトへのエクスポート（STEP、IGES、STL等）も可能</li>
</ul>
<h2 id="出力例">出力例</h2>
<div class="codehilite"><pre><span></span><code>=== 建物評価テスト実行開始 ===

入力パラメータ:
  Lx: 8.5
  Ly: 9.0
  H1: 3.0
  H2: 3.0
  tf: 400
  tr: 450
  bc: 450
  hc: 450
  tw_ext: 350
  wall_tilt_angle: -25
  window_ratio_2f: 0.7
  roof_morph: 0.9
  roof_shift: 0.4
  balcony_depth: 1.8
  material_columns: 0 (コンクリート)
  material_floor1: 0 (コンクリート)
  material_floor2: 0 (コンクリート)
  material_roof: 0 (コンクリート)
  material_walls: 1 (木材)
  material_balcony: 0 (コンクリート)

解析実行中...

=== 解析結果 ===

【安全性】
  安全率: 1.079
  最大変位: 8.116 mm
  最大応力: 32.433 MPa

【経済性】
  建設コスト: 618,276 円/㎡
  総工費: 47,298,095 円

【環境性】
  CO2排出量: 1571.2 kg-CO2/㎡
  最適化ポテンシャル: 25.0%

【快適性】
  快適性スコア: 5.86/10
    空間の広がり: 0.50
    採光・眺望: 7.45
    開放感: -1.50
    プライバシー: 4.00

【施工性】
  施工性スコア: 4.25/10

✅ 結果をCSVファイルに保存しました: test_results.csv
🗑️ 生成された.FCBakファイルを削除中...
   削除: test_building_20250810_132410.FCBak
✅ 1個の.FCBakファイルを削除しました

=== テスト完了 ===
</code></pre></div>

<h3 id="テスト実行方法">テスト実行方法</h3>
<h4>Mac</h4>
<div class="codehilite"><pre><span></span><code>/Applications/FreeCAD.app/Contents/Resources/bin/freecadcmd<span class="w"> </span>test_generate_building.py
</code></pre></div>

<h4>Windows</h4>
<div class="codehilite"><pre><span></span><code><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="s2">&quot;C:\Program Files\FreeCAD 1.0\bin\freecadcmd.exe&quot;</span><span class="w"> </span>test_generate_building.py
</code></pre></div>

<p><strong>注意</strong>: 上記のパスはお使いのPCの環境に合わせて調整してください．</p>
<h3 id="出力データ">出力データ</h3>
<p><code>test_results.csv</code>には以下の情報が記録されます（ファイルが存在しない場合は自動作成，既存の場合は追記）：</p>
<p>• <strong>設計パラメータ（20個）</strong></p>
<table>
<thead>
<tr>
<th>カテゴリ</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>基本形状</td>
<td>建物幅，奥行，各階高さ</td>
</tr>
<tr>
<td>構造寸法</td>
<td>床・屋根スラブ厚，柱サイズ，壁厚</td>
</tr>
<tr>
<td>追加要素</td>
<td>壁傾斜角，窓面積比，屋根形状，バルコニー奥行</td>
</tr>
<tr>
<td>材料選択</td>
<td>各部位の材料（0:コンクリート，1:木材）</td>
</tr>
</tbody>
</table>
<p>• <strong>評価指標（5項目）</strong></p>
<table>
<thead>
<tr>
<th>評価項目</th>
<th>説明</th>
<th>単位</th>
</tr>
</thead>
<tbody>
<tr>
<td>安全率</td>
<td>FEM解析による構造安全性</td>
<td>-</td>
</tr>
<tr>
<td>コスト</td>
<td>建設費用</td>
<td>円/m²</td>
</tr>
<tr>
<td>CO2排出量</td>
<td>環境負荷</td>
<td>kg-CO2/m²</td>
</tr>
<tr>
<td>快適性スコア</td>
<td>空間品質評価</td>
<td>0-10</td>
</tr>
<tr>
<td>施工性スコア</td>
<td>施工難易度評価</td>
<td>0-10</td>
</tr>
</tbody>
</table>
<p>• <strong>実行メタデータ</strong></p>
<ul>
<li>タイムスタンプ: 実行日時</li>
<li>処理時間: 評価に要した時間 [秒]</li>
<li>FCStdファイルパス: 生成された3Dモデルファイル</li>
</ul>
<hr />
<h2 id="システム構成と関係図">システム構成と関係図</h2>
<h3 id="データフローの詳細">データフローの詳細</h3>
<div class="mermaid">
sequenceDiagram
    participant User as ユーザー
    participant Test as test_generate_building.py
    participant Core as generate_building_fem_analyze.py
    participant FC as FreeCAD
    participant CCX as CalculiX
    
    User->>Test: 実行コマンド
    Test->>Test: パラメータ準備（20個）
    Test->>Core: evaluate_building_from_params()
    
    Core->>FC: 3Dモデル生成
    FC-->>Core: Partオブジェクト
    
    Core->>Core: メッシュ生成
    Core->>CCX: FEM解析実行
    CCX-->>Core: 応力・変位結果
    
    Core->>Core: 評価指標計算
    Note over Core: 安全性，経済性，<br/>環境性，快適性，<br/>施工性
    
    Core-->>Test: results辞書
    Test->>Test: 結果整形
    Test->>User: コンソール表示
    Test->>Test: CSV追記
    Core->>FC: FCStd保存
    Test->>Test: FCBakファイル削除
</div>

<h2 id="注意事項">注意事項</h2>
<ol>
<li>FreeCADのコマンドライン版（freecadcmd）で実行する必要があります</li>
<li><code>generate_building_fem_analyze.py</code>が同じディレクトリに存在する必要があります</li>
<li>CalculiXがインストールされている必要があります（FEM解析用）</li>
<li>実行時間は通常2〜5秒程度ですが，複雑な形状では長くなることがあります</li>
<li>FCBakファイルは実行ごとに自動的に削除されます（ディスク容量の節約）</li>
</ol>
<h2 id="トラブルシューティング">トラブルシューティング</h2>
<h3 id="modulenotfounderror">ModuleNotFoundError</h3>
<p>親ディレクトリにFem.pyなどの競合するファイルがある場合，モジュールの読み込みエラーが発生することがあります．このスクリプトは現在のディレクトリのみをPythonパスに追加するよう設計されています．</p>
<h3 id="fem解析エラー">FEM解析エラー</h3>
<p>メッシュ生成やソルバー実行でエラーが発生した場合，VERBOSE_OUTPUTを有効にして詳細なエラー情報を確認してください．</p>
<h3 id="csv出力エラー">CSV出力エラー</h3>
<p>ファイルが他のプログラムで開かれている場合，書き込みエラーが発生します．CSVファイルを閉じてから再実行してください．</p>
            </article>
        </main>
    </div>
    
    <a href="#" class="back-to-top" id="back-to-top">↑ トップへ</a>
    
    <script>
        // スムーズスクロール
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
        
        // アクティブセクションのハイライト
        const sections = document.querySelectorAll('h1[id], h2[id], h3[id]');
        const navLinks = document.querySelectorAll('.sidebar a[href^="#"]');
        
        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                const sectionHeight = section.offsetHeight;
                if (scrollY >= (sectionTop - 100)) {
                    current = section.getAttribute('id');
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
            
            // Back to top ボタンの表示/非表示
            const backToTop = document.getElementById('back-to-top');
            if (window.scrollY > 300) {
                backToTop.classList.add('visible');
            } else {
                backToTop.classList.remove('visible');
            }
        });
        
        // MathJax再処理
        if (window.MathJax && window.MathJax.typesetPromise) {
            MathJax.typesetPromise();
        }
    </script>
</body>
</html>
