<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Test - Fixed Version</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        
        // Mermaid初期化
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });
        
        // ページ読み込み完了後に手動で実行
        window.addEventListener('load', async () => {
            const graphs = document.querySelectorAll('.mermaid');
            for (let i = 0; i < graphs.length; i++) {
                const graphDef = graphs[i].textContent;
                const id = `mermaid-${i}`;
                graphs[i].id = id;
                try {
                    const { svg } = await mermaid.render(id + '-svg', graphDef);
                    graphs[i].innerHTML = svg;
                } catch (e) {
                    console.error('Mermaid rendering error:', e);
                    graphs[i].innerHTML = '<p style="color: red;">図の表示エラー</p>';
                }
            }
        });
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #0366d6;
            padding-bottom: 10px;
        }
        .mermaid {
            background: #f6f8fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Mermaid図表示テスト（修正版）</h1>
    
    <h2>データの流れ</h2>
    <div class="mermaid">
graph LR
    subgraph "入力"
        P[20個のパラメータ<br/>辞書形式]
    end
    
    subgraph "test_generate_building.py"
        T1[パラメータ準備]
        T2[BuildingDesigner呼び出し]
        T3[結果処理]
    end
    
    subgraph "generate_building_fem_analyze.py"
        G1[BuildingDesignerクラス]
        G2[create_building]
        G3[run_fem_analysis]
        G4[calculate_all_evaluations]
    end
    
    P --> T1
    T1 --> T2
    T2 --> G1
    G1 --> G2
    G2 --> G3
    G3 --> G4
    G4 --> T3
    </div>

    <h2>システム構成</h2>
    <div class="mermaid">
graph TB
    subgraph "入力層"
        UI[ユーザー入力/設定ファイル]
    end
    
    subgraph "実行層"
        TB[test_generate_building.py]
        GB[generate_building_fem_analyze.py]
    end
    
    subgraph "3Dモデリング層"
        FC[FreeCAD API]
        FM[FEMモジュール]
    end
    
    subgraph "解析層"
        CX[CalculiX Solver]
    end
    
    subgraph "出力層"
        FCStd[.FCStdファイル]
        CSV[評価結果CSV]
        LOG[ログファイル]
    end
    
    UI --> TB
    TB --> GB
    GB --> FC
    FC --> FM
    FM --> CX
    CX --> GB
    GB --> FCStd
    GB --> CSV
    TB --> LOG
    </div>

    <p>このページでMermaid図が正しく表示されれば、同じ方法を他のHTMLファイルにも適用できます。</p>
</body>
</html>