# -*- coding: utf-8 -*-
"""
FreeCADãƒã‚¯ãƒ­: ææ–™ã«åŸºã¥ã„ã¦è‰²ã‚’é©ç”¨ï¼ˆå¯è¦–åŒ–ãƒ»è¦–ç‚¹èª¿æ•´ä»˜ãï¼‰
ä½¿ã„æ–¹:
1. FreeCADã§FCStdãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
2. ãƒã‚¯ãƒ­ â†’ ãƒã‚¯ãƒ­... â†’ ApplyColorsComplete.FCMacro ã‚’å®Ÿè¡Œ
3. è‡ªå‹•çš„ã«è‰²ãŒé©ç”¨ã•ã‚Œã€è¦–ç‚¹ã‚‚èª¿æ•´ã•ã‚Œã‚‹
"""

import FreeCAD
import FreeCADGui as Gui
from PySide import QtGui

def get_material_from_properties(obj):
    '''ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ææ–™ã‚¿ã‚¤ãƒ—ã‚’å–å¾—'''
    if hasattr(obj, 'MaterialType'):
        return obj.MaterialType
    
    # MaterialTypeãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆã¯ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç¢ºèª
    if hasattr(obj, 'Label'):
        label = obj.Label.lower()
        if 'wood' in label or 'æœ¨' in label:
            return 1
        elif 'concrete' in label or 'ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ' in label:
            return 0
    
    return None

def apply_colors_and_view():
    '''ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è‰²ã‚’é©ç”¨ã—ã€è¦–ç‚¹ã‚’èª¿æ•´'''
    
    if not FreeCAD.ActiveDocument:
        QtGui.QMessageBox.warning(None, "è­¦å‘Š", "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒé–‹ã‹ã‚Œã¦ã„ã¾ã›ã‚“")
        return
    
    # æœ¨æè‰²ã®å®šç¾©ï¼ˆãƒ‘ãƒ¼ãƒ„ã”ã¨ã«å¾®å¦™ã«ç•°ãªã‚‹è‰²ï¼‰
    wood_colors = {
        'Foundation': (0.85, 0.7, 0.5),     # åŸºç¤ï¼ˆè–„ã„é»„åœŸè‰²ï¼‰
        'Floor1': (0.9, 0.75, 0.55),        # 1éšåºŠï¼ˆæ˜ã‚‹ã„ãƒ™ãƒ¼ã‚¸ãƒ¥ï¼‰
        'Floor2': (0.95, 0.8, 0.6),         # 2éšåºŠï¼ˆéå¸¸ã«è–„ã„èŒ¶è‰²ï¼‰
        'Columns': (0.8, 0.65, 0.45),       # æŸ±ï¼ˆæ˜ã‚‹ã„èŒ¶è‰²ï¼‰
        'Walls': (0.75, 0.55, 0.35),        # å£ï¼ˆæ¿ƒã„èŒ¶è‰²ï¼‰
        'RoofSlab': (0.75, 0.6, 0.4),       # å±‹æ ¹ï¼ˆæ˜ã‚‹ã‚ã®èŒ¶è‰²ï¼‰
        'Balcony': (0.85, 0.75, 0.6),       # ãƒãƒ«ã‚³ãƒ‹ãƒ¼ï¼ˆè–„ã„èŒ¶è‰²ï¼‰
        'Staircase': (0.8, 0.7, 0.55)       # éšæ®µï¼ˆæ˜ã‚‹ã„èŒ¶è‰²ï¼‰
    }
    concrete_color = (0.9, 0.9, 0.9)  # ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆï¼ˆéå¸¸ã«æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼ï¼‰
    
    # ä¿®æ­£å¯¾è±¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    building_parts = ['Foundation', 'Floor1', 'Floor2', 'Columns', 'Walls', 'RoofSlab', 'Balcony', 'Staircase']
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆææ–™è¨­å®šï¼ˆææ–™æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…¨ã¦ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆï¼‰
    default_material = 0  # 0: ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ
    
    FreeCAD.Console.PrintMessage("=== ææ–™è‰²é©ç”¨é–‹å§‹ ===\n")
    FreeCAD.Console.PrintMessage("ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ææ–™æƒ…å ±ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™...\n")
    
    # å„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ææ–™ã‚’ç¢ºèª
    material_info = {}
    for obj_name in building_parts:
        obj = FreeCAD.ActiveDocument.getObject(obj_name)
        if obj:
            material = get_material_from_properties(obj)
            if material is not None:
                material_info[obj_name] = material
                material_name = "æœ¨æ" if material == 1 else "ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ"
                FreeCAD.Console.PrintMessage(f"  {obj_name}: {material_name}\n")
    
    applied_count = 0
    wood_count = 0
    concrete_count = 0
    unknown_count = 0
    
    for obj_name in building_parts:
        obj = FreeCAD.ActiveDocument.getObject(obj_name)
        if obj:
            if hasattr(obj, 'ViewObject') and obj.ViewObject is not None:
                
                # ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ææ–™ã‚’åˆ¤å®š
                material = get_material_from_properties(obj)
                
                # ææ–™ãŒä¸æ˜ãªå ´åˆã¯ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã¨ã—ã¦æ‰±ã†
                if material is None:
                    material = default_material
                    FreeCAD.Console.PrintMessage(f"â“ {obj.Label}: ææ–™æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã¨ã—ã¦æ‰±ã„ã¾ã™\n")
                    unknown_count += 1
                
                # ææ–™ã«å¿œã˜ã¦è‰²ã‚’è¨­å®š
                try:
                    if material == 1:  # æœ¨æ
                        color = wood_colors.get(obj.Label, wood_colors.get('Walls'))
                        wood_count += 1
                    else:  # ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ
                        color = concrete_color
                        concrete_count += 1
                    
                    # è‰²ã‚’è¨­å®š
                    obj.ViewObject.ShapeColor = color
                    
                    # é€æ˜åº¦ã‚’0ã«è¨­å®šï¼ˆä¸é€æ˜ï¼‰
                    if hasattr(obj.ViewObject, 'Transparency'):
                        obj.ViewObject.Transparency = 0
                    
                    # å¯è¦–æ€§ã‚’ç¢ºå®Ÿã«è¨­å®š
                    obj.ViewObject.Visibility = True
                    
                    # ãƒ„ãƒªãƒ¼ã«ã‚‚è¡¨ç¤º
                    if hasattr(obj.ViewObject, 'ShowInTree'):
                        obj.ViewObject.ShowInTree = True
                    
                    # DisplayModeã‚’Flat Linesã«è¨­å®šï¼ˆé¢ã®è‰²ï¼‹ã‚¨ãƒƒã‚¸ç·šï¼‰
                    if hasattr(obj.ViewObject, 'DisplayMode'):
                        try:
                            obj.ViewObject.DisplayMode = "Flat Lines"
                        except:
                            pass
                    
                    applied_count += 1
                    material_name = "æœ¨æ" if material == 1 else "ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ"
                    FreeCAD.Console.PrintMessage(f"âœ… {obj.Label}: {material_name}è‰²ã‚’é©ç”¨ RGB{color}\n")
                    
                except Exception as e:
                    FreeCAD.Console.PrintError(f"âš ï¸ {obj.Label}: è‰²ã®é©ç”¨ä¸­ã«ã‚¨ãƒ©ãƒ¼: {str(e)}\n")
            else:
                FreeCAD.Console.PrintWarning(f"âš ï¸ {obj_name}: ViewObjectãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n")
        else:
            FreeCAD.Console.PrintError(f"âŒ {obj_name}: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n")
    
    # GUIã‚’æ›´æ–°
    if hasattr(Gui, 'updateGui'):
        Gui.updateGui()
    
    # ãƒ“ãƒ¥ãƒ¼ã‚’èª¿æ•´ï¼ˆå…¨ä½“è¡¨ç¤ºï¼†ã‚¢ã‚¤ã‚½ãƒ¡ãƒˆãƒªãƒƒã‚¯ï¼‰
    try:
        Gui.SendMsgToActiveView("ViewFit")
        Gui.activeDocument().activeView().viewIsometric()
        FreeCAD.Console.PrintMessage("\nâœ… ãƒ“ãƒ¥ãƒ¼ã‚’èª¿æ•´ã—ã¾ã—ãŸï¼ˆå…¨ä½“è¡¨ç¤ºãƒ»ã‚¢ã‚¤ã‚½ãƒ¡ãƒˆãƒªãƒƒã‚¯ï¼‰\n")
    except Exception as e:
        FreeCAD.Console.PrintError(f"\nâš ï¸ ãƒ“ãƒ¥ãƒ¼èª¿æ•´ä¸­ã«ã‚¨ãƒ©ãƒ¼: {str(e)}\n")
    
    # çµæœã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã§è¡¨ç¤º
    msg = f"=== å‡¦ç†å®Œäº† ===\n\n"
    msg += f"âœ… {applied_count} å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è‰²ã‚’é©ç”¨ã—ã¾ã—ãŸ\n"
    msg += f"ğŸ“Š å†…è¨³: æœ¨æ {wood_count}å€‹ã€ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ {concrete_count}å€‹\n"
    if unknown_count > 0:
        msg += f"\nâš ï¸ {unknown_count}å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ææ–™æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãšã€\nã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã¨ã—ã¦æ‰±ã„ã¾ã—ãŸ"
    
    QtGui.QMessageBox.information(None, "è‰²ä»˜ã‘å®Œäº†", msg)
    
    FreeCAD.Console.PrintMessage(f"\n=== å‡¦ç†å®Œäº† ===\n")
    FreeCAD.Console.PrintMessage(f"âœ… {applied_count} å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è‰²ã‚’é©ç”¨ã—ã¾ã—ãŸ\n")
    FreeCAD.Console.PrintMessage(f"ğŸ“Š å†…è¨³: æœ¨æ {wood_count}å€‹ã€ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ {concrete_count}å€‹\n")
    if unknown_count > 0:
        FreeCAD.Console.PrintMessage(f"âš ï¸  {unknown_count}å€‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ææ–™æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãšã€ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã¨ã—ã¦æ‰±ã„ã¾ã—ãŸ\n")

# å®Ÿè¡Œ
apply_colors_and_view()